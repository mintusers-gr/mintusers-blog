#!/usr/bin/env bash
set -e

if [ ! -d /vagrant ]
then
  echo "$(tput setaf 6)*************************************************$(tput sgr0)"
  echo "$(tput setaf 6)*   Please run Jekyll only inside guest         *$(tput sgr0)"
  echo "$(tput setaf 6)*************************************************$(tput sgr0)"
  exit
fi

source /vagrant/.env
/vagrant/bin/check-config
cd /vagrant

echo -e "$(tput setaf 5)*************************************************$(tput sgr0)"
echo -e "$(tput setaf 5)*          Building Production site             *$(tput sgr0)"
echo -e "$(tput setaf 5)*************************************************$(tput sgr0)"

JEKYLL_ENV=production bin/jekyll build  --trace
if [ 0 -ne $? ]; then
  echo -e "$(tput setaf 1)Build failed :-($(tput sgr0)\n"
  exit
fi;

echo -e "$(tput setaf 5)*************************************************$(tput sgr0)"
echo -e "$(tput setaf 5)*          Gzip all HTML, CSS and JS            *$(tput sgr0)"
echo -e "$(tput setaf 5)*************************************************$(tput sgr0)"

find /vagrant/build/ -iname '*.html' -exec gzip -n -k -f {} +
find /vagrant/build/ -iname '*.js'   -exec gzip -n -k -f {} +
find /vagrant/build/ -iname '*.css'  -exec gzip -n -k -f {} +

echo -e "\n\n"
echo -e "$(tput setaf 5)*************************************************$(tput sgr0)"
echo -e "$(tput setaf 5)*  Serving production site to local preview     *$(tput sgr0)"
echo -e "$(tput setaf 5)*************************************************$(tput sgr0)"
echo -e "$(tput setaf 6)The webservice URL is http://${BOX_HOSTNAME}:4000$(tput sgr0)"

# Kill everything that use port 4000
set +e
fuser -k 4000/tcp
set -e

cd /vagrant/build
ruby -run -ehttpd . -p4000
